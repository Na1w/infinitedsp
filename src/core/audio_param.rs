use crate::core::parameter::Parameter;
use crate::FrameProcessor;
use alloc::boxed::Box;

/// A parameter that can be static, dynamic (controlled by another processor), or linked to a thread-safe Parameter.
pub enum AudioParam {
    /// A constant value.
    Static(f32),
    /// A value generated by another processor (e.g., LFO, Envelope).
    Dynamic(Box<dyn FrameProcessor + Send>),
    /// A value linked to a shared Parameter (e.g., UI control).
    Linked(Parameter),
}

impl AudioParam {
    /// Fills the buffer with parameter values for the current block.
    pub fn process(&mut self, buffer: &mut [f32], sample_index: u64) {
        match self {
            AudioParam::Static(val) => {
                buffer.fill(*val);
            }
            AudioParam::Dynamic(processor) => {
                processor.process(buffer, sample_index);
            }
            AudioParam::Linked(param) => {
                let val = param.get();
                buffer.fill(val);
            }
        }
    }

    /// Returns the constant value if the parameter is Static or Linked.
    /// Returns None if the parameter is Dynamic.
    ///
    /// This allows processors to optimize for the common case where parameters
    /// are constant for the duration of a block.
    pub fn get_constant(&self) -> Option<f32> {
        match self {
            AudioParam::Static(val) => Some(*val),
            AudioParam::Linked(param) => Some(param.get()),
            AudioParam::Dynamic(_) => None,
        }
    }

    /// Sets the sample rate for dynamic parameters.
    pub fn set_sample_rate(&mut self, sample_rate: f32) {
        if let AudioParam::Dynamic(p) = self {
            p.set_sample_rate(sample_rate);
        }
    }

    /// Creates a static AudioParam representing a frequency in Hz.
    pub fn hz(hz: f32) -> Self {
        AudioParam::Static(hz)
    }

    /// Creates a static AudioParam representing a time in Seconds.
    pub fn seconds(seconds: f32) -> Self {
        AudioParam::Static(seconds)
    }

    /// Creates a static AudioParam representing a time in Milliseconds, converted to Seconds.
    pub fn ms(ms: f32) -> Self {
        AudioParam::Static(ms / 1000.0)
    }

    /// Creates a static AudioParam representing a value in Decibels.
    /// Note: The receiver must expect dB values. This does not convert to linear gain.
    pub fn db(db: f32) -> Self {
        AudioParam::Static(db)
    }

    /// Creates a static AudioParam representing a linear value (e.g. gain, ratio).
    pub fn linear(val: f32) -> Self {
        AudioParam::Static(val)
    }
}
